<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Crop Estimator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body class="landing-body">
    <div class="header">
      <h2>Admin Dashboard</h2>
      <div class="bx bx-menu" id="menu-icon"></div>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar">
      <h2>Crop Estimator</h2>
      <a href="dashboard.html">Dashboard</a>
      <a href="admin.html">Admin</a>
      <a href="signout.html">Logout</a>
    </div>
    <div class="main">
      <h1>Admin Panel</h1>
      <div class="form-section">
        <div style="display: flex; gap: 20px; margin-bottom: 20px">
          <button id="usersTab" class="submit-btn">Users</button>
          <button id="predictionsTab" class="submit-btn">Predictions</button>
        </div>
        <div id="adminContent"></div>
      </div>
    </div>
    <script src="script.js"></script>
    <script>
      // Helper function: Convert UTC datetime to local time
      function formatUTCtoLocal(utcString) {
        if (!utcString) return "";
        const date = new Date(utcString + "Z"); // force UTC
        return date.toLocaleString(); // convert to local time
      }

      // Tab switching logic
      const usersTab = document.getElementById("usersTab");
      const predictionsTab = document.getElementById("predictionsTab");
      const adminContent = document.getElementById("adminContent");
      let currentTab = "users";
      let currentPage = 1;
      let perPage = 20;

      function showUsers(page = 1) {
        adminContent.innerHTML = "<div>Loading users...</div>";
        fetch(
          `http://127.0.0.1:5000/admin/users?page=${page}&per_page=${perPage}`
        )
          .then((res) => res.json())
          .then((data) => {
            let html = `<h2>All Users</h2><input type="text" id="userFilter" placeholder="Filter by email..." style="margin-bottom:10px;" />`;
            html += `<table style="width:100%;border-collapse:collapse;"><tr><th>ID</th><th>Name</th><th>Email</th><th>Created At</th></tr>`;
            data.forEach((user) => {
              html += `<tr><td>${user.id}</td><td>${user.full_name}</td><td>${
                user.email
              }</td><td>${formatUTCtoLocal(user.created_at)}</td></tr>`;
            });
            html += `</table>`;
            html += `<div style="margin-top:10px;"><button id="prevUserPage" class="submit-btn">Prev</button> <span>Page ${page}</span> <button id="nextUserPage" class="submit-btn">Next</button></div>`;
            adminContent.innerHTML = html;
            document.getElementById("prevUserPage").onclick = () => {
              if (page > 1) showUsers(page - 1);
            };
            document.getElementById("nextUserPage").onclick = () => {
              showUsers(page + 1);
            };
            document.getElementById("userFilter").oninput = function () {
              const val = this.value.toLowerCase();
              const rows = adminContent.querySelectorAll("table tr");
              rows.forEach((row, i) => {
                if (i === 0) return;
                row.style.display = row.children[2].textContent
                  .toLowerCase()
                  .includes(val)
                  ? ""
                  : "none";
              });
            };
          });
      }

      function showPredictions(page = 1) {
        adminContent.innerHTML = "<div>Loading predictions...</div>";
        apiFetch(
          `http://127.0.0.1:5000/admin/users?page=${page}&per_page=${perPage}`
        )
          .then((res) => res.json())
          .then((data) => {
            let html = `<h2>All Predictions</h2><input type="text" id="cropFilter" placeholder="Filter by crop..." style="margin-bottom:10px;" />`;
            html += `<table style="width:100%;border-collapse:collapse;"><tr><th>ID</th><th>User ID</th><th>Crop</th><th>Date</th><th>N</th><th>P</th><th>K</th><th>Temp</th><th>Humidity</th><th>pH</th><th>Rainfall</th></tr>`;
            data.forEach((pred) => {
              html += `<tr><td>${pred.id}</td><td>${pred.user_id}</td><td>${
                pred.predicted_crop
              }</td><td>${formatUTCtoLocal(pred.created_at)}</td><td>${
                pred.nitrogen
              }</td><td>${pred.phosphorus}</td><td>${pred.potassium}</td><td>${
                pred.temperature
              }</td><td>${pred.humidity}</td><td>${pred.ph}</td><td>${
                pred.rainfall
              }</td></tr>`;
            });
            html += `</table>`;
            html += `<div style="margin-top:10px;"><button id="prevPredPage" class="submit-btn">Prev</button> <span>Page ${page}</span> <button id="nextPredPage" class="submit-btn">Next</button></div>`;
            adminContent.innerHTML = html;
            document.getElementById("prevPredPage").onclick = () => {
              if (page > 1) showPredictions(page - 1);
            };
            document.getElementById("nextPredPage").onclick = () => {
              showPredictions(page + 1);
            };
            document.getElementById("cropFilter").oninput = function () {
              const val = this.value.toLowerCase();
              const rows = adminContent.querySelectorAll("table tr");
              rows.forEach((row, i) => {
                if (i === 0) return;
                row.style.display = row.children[2].textContent
                  .toLowerCase()
                  .includes(val)
                  ? ""
                  : "none";
              });
            };
          });
      }

      usersTab.onclick = () => {
        currentTab = "users";
        showUsers();
      };
      predictionsTab.onclick = () => {
        currentTab = "predictions";
        showPredictions();
      };
      // Default tab
      showUsers();
    </script>
  </body>
</html>
